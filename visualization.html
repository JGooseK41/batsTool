<!DOCTYPE html>
<html>
<head>
    <title>B.A.T.S. Investigation Visualization</title>
    <meta charset="UTF-8">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; overflow: hidden; }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 4px 15px rgba(44, 62, 80, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header h1 {
            font-size: 1.8rem;
            color: #FFBF00;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
            color: #ffffff;
            margin-top: 5px;
        }
        .controls {
            background: white;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            font-weight: 500;
        }
        .controls button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-warning { background: #f39c12; color: white; }

        /* Dropdown styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 4px;
            overflow: hidden;
        }
        .dropdown-content button {
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            background: white;
            color: #2c3e50;
            border: none;
            border-bottom: 1px solid #ecf0f1;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .dropdown-content button:last-child {
            border-bottom: none;
        }
        .dropdown-content button:hover {
            background: #f8f9fa;
            transform: none;
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }

        #vizCanvas {
            width: 100%;
            height: calc(100vh - 160px);
            position: relative;
            background: #fafafa;
        }
        canvas { display: block; }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 1.2rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>B.A.T.S.</h1>
            <p id="case-title">Loading Investigation...</p>
        </div>
    </div>

    <div class="controls">
        <span style="font-weight: 600; margin-right: 10px;">Layout:</span>
        <button class="btn-primary" onclick="changeLayout('hop-columns')">üìä Hop Columns</button>
        <button class="btn-primary" onclick="changeLayout('sankey')">üåä Sankey Diagram</button>
        <button class="btn-primary" onclick="toggleOrientation()">üîÑ Rotate View</button>
        <span style="flex: 1;"></span>
        <button class="btn-secondary" onclick="resetView()">‚Ü∫ Reset View</button>
        <button class="btn-secondary" onclick="fitToScreen()">üìê Fit to Screen</button>
        <button class="btn-warning" onclick="saveVisualization()">üíæ Save Changes</button>
        <div class="dropdown">
            <button class="btn-success">üì§ Export ‚ñº</button>
            <div class="dropdown-content">
                <button onclick="exportVisualization('png')">üì∏ Export as PNG</button>
                <button onclick="exportVisualization('svg')">üìÑ Export as SVG</button>
                <button onclick="exportStandaloneHTML()">üì¶ Standalone HTML</button>
                <button onclick="exportPDF()">üìã PDF Report</button>
            </div>
        </div>
    </div>

    <div id="vizCanvas">
        <div id="loading">Initializing D3 visualization engine...</div>
    </div>

    <!-- D3.js Library (local copy) -->
    <script src="d3.v7.min.js"></script>
    <script src="d3-sankey.min.js"></script>
    <script src="bats-d3-visualization.js"></script>
    <script>
        let vizEngine;
        let investigation;

        function initializeVisualization(data) {
            try {
                console.log('üé® Initializing D3 visualization...');

                investigation = data;

                // Update header
                const caseTitle = document.getElementById('case-title');
                if (caseTitle) {
                    caseTitle.textContent = 'Investigation Visualization: ' + (investigation.caseId || 'Untitled');
                }

                // Remove loading message
                const loading = document.getElementById('loading');
                if (loading) loading.remove();

                // Initialize D3 engine
                vizEngine = new BATSVisualizationD3('vizCanvas');
                vizEngine.loadInvestigation(investigation);

                console.log('‚úÖ D3 Visualization initialized');
            } catch (error) {
                console.error('Error initializing visualization:', error);
                alert('Failed to initialize visualization: ' + error.message);
            }
        }

        function changeLayout(type) {
            if (vizEngine) {
                vizEngine.setLayout(type);
            }
        }

        function resetView() {
            if (vizEngine) {
                vizEngine.resetView();
            }
        }

        function fitToScreen() {
            if (vizEngine) {
                vizEngine.fitToView();
            }
        }

        function toggleOrientation() {
            if (vizEngine) {
                vizEngine.toggleOrientation();
            }
        }

        function saveVisualization() {
            if (!investigation) {
                alert('No investigation data to save.');
                return;
            }

            // Update investigation data with current node positions
            if (vizEngine && vizEngine.nodes) {
                // Save current node positions and any modifications
                vizEngine.nodes.forEach(node => {
                    // Find corresponding entry in investigation and update positions
                    if (node.savedPosition) {
                        node.savedPosition = { x: node.x, y: node.y };
                    }
                });
            }

            // Save back to opener window if available
            if (window.opener && window.opener.investigation) {
                window.opener.investigation = investigation;
                alert('‚úÖ Changes saved! Node positions and labels have been updated in the main investigation.');
            } else {
                // Fallback: download updated investigation JSON
                const dataStr = JSON.stringify(investigation, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${investigation.caseId || 'investigation'}_updated.json`;
                link.click();
                URL.revokeObjectURL(url);
                alert('‚úÖ Investigation data downloaded with current node positions!');
            }
        }

        function exportVisualization(format) {
            if (!vizEngine) return;

            const filename = 'bats_visualization_' + (investigation.caseId || 'export');

            if (format === 'png') {
                vizEngine.exportPNG(filename + '.png');
            } else if (format === 'svg') {
                vizEngine.exportSVG(filename + '.svg');
            }
        }

        async function exportStandaloneHTML() {
            if (!investigation) {
                alert('No investigation data available to export.');
                return;
            }

            console.log('Generating standalone HTML export...');

            // Read D3 library files
            const d3Code = await fetch('d3.v7.min.js').then(r => r.text());
            const d3SankeyCode = await fetch('d3-sankey.min.js').then(r => r.text());
            const vizEngineCode = await fetch('bats-d3-visualization.js').then(r => r.text());

            // Serialize investigation data
            const investigationJSON = JSON.stringify(investigation, null, 2);

            // Create standalone HTML file
            // Note: Using SCRIPT_END placeholder to avoid </script> tag parsing issues
            const standaloneHTML = `<!DOCTYPE html>
<html>
<head>
    <title>B.A.T.S. Investigation Visualization - ${investigation.caseId || 'Untitled'}</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; overflow: hidden; }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 4px 15px rgba(44, 62, 80, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header h1 {
            font-size: 1.8rem;
            color: #FFBF00;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
            color: #ffffff;
            margin-top: 5px;
        }
        .controls {
            background: white;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            font-weight: 500;
        }
        .controls button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-primary { background: #3498db; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        #vizCanvas {
            width: 100%;
            height: calc(100vh - 160px);
            position: relative;
            background: #fafafa;
        }
        canvas { display: block; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>B.A.T.S. Investigation Visualization</h1>
            <p>Case: ${investigation.caseId || 'Untitled'} | Standalone Export</p>
        </div>
    </div>

    <div class="controls">
        <span style="font-weight: 600; margin-right: 10px;">Layout:</span>
        <button class="btn-primary" onclick="changeLayout('hop-columns')">üìä Hop Columns</button>
        <button class="btn-primary" onclick="changeLayout('sankey')">üåä Sankey Diagram</button>
        <span style="flex: 1;"></span>
        <button class="btn-secondary" onclick="resetView()">üîÑ Reset View</button>
        <button class="btn-secondary" onclick="fitToScreen()">üìê Fit to Screen</button>
    </div>

    <div id="vizCanvas"></div>

    <script>
// D3.js Library
${d3Code}
    SCRIPT_END

    <script>
// D3 Sankey Plugin
${d3SankeyCode}
    SCRIPT_END

    <script>
// B.A.T.S. Visualization Engine
${vizEngineCode}
    SCRIPT_END

    <script>
        // Investigation Data
        const investigation = ${investigationJSON};

        let vizEngine;

        function initializeVisualization() {
            console.log('üé® Initializing standalone B.A.T.S. visualization...');
            vizEngine = new BATSVisualizationD3('vizCanvas');
            vizEngine.loadInvestigation(investigation);
            console.log('‚úÖ Visualization initialized');
        }

        function changeLayout(type) {
            if (vizEngine) {
                vizEngine.setLayout(type);
            }
        }

        function resetView() {
            if (vizEngine) {
                vizEngine.resetView();
            }
        }

        function fitToScreen() {
            if (vizEngine) {
                vizEngine.fitToView();
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initializeVisualization();
        });
    SCRIPT_END
</body>
</html>`.replace(/SCRIPT_END/g, '</script>');

            // Create download
            const blob = new Blob([standaloneHTML], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `BATS_${investigation.caseId || 'Investigation'}_Standalone.html`;
            link.click();
            URL.revokeObjectURL(url);

            alert('Standalone HTML file downloaded! Open it in any browser to view the interactive visualization.');
        }

        function exportPDF() {
            if (!vizEngine) {
                alert('Visualization not initialized.');
                return;
            }

            alert('Generating PDF report... This may take a moment.');

            // Capture current visualization as SVG
            const svgElement = vizEngine.svg.node();
            const serializer = new XMLSerializer();
            const svgString = serializer.serializeToString(svgElement);

            // Create canvas for conversion
            const canvas = document.createElement('canvas');
            canvas.width = vizEngine.config.width;
            canvas.height = vizEngine.config.height;
            const ctx = canvas.getContext('2d');

            const img = new Image();
            const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            img.onload = () => {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                URL.revokeObjectURL(url);

                // Convert to image data
                const imgData = canvas.toDataURL('image/png');

                // Create PDF content
                generatePDFReport(imgData);
            };

            img.src = url;
        }

        function generatePDFReport(visualizationImage) {
            // Create PDF using simple HTML-to-print approach
            const printWindow = window.open('', '_blank');

            const pdfHTML = `<!DOCTYPE html>
<html>
<head>
    <title>B.A.T.S. Investigation Report - ${investigation.caseId || 'Untitled'}</title>
    <style>
        @media print {
            @page { size: landscape; margin: 1cm; }
            body { margin: 0; }
            .no-print { display: none; }
        }
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { border-bottom: 4px solid #FFBF00; padding-bottom: 20px; margin-bottom: 20px; }
        .header h1 { color: #2c3e50; font-size: 32px; margin: 0; }
        .header h1 span { color: #FFBF00; }
        .header p { color: #7f8c8d; font-size: 14px; margin-top: 10px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .info-box { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db; }
        .info-box h3 { color: #2c3e50; font-size: 14px; margin: 0 0 10px 0; }
        .info-box p { color: #34495e; margin: 5px 0; font-size: 13px; }
        .visualization { margin-top: 30px; page-break-before: always; }
        .visualization img { width: 100%; height: auto; border: 1px solid #ddd; }
        .print-btn { background: #27ae60; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; }
        .print-btn:hover { background: #229954; }
    </style>
</head>
<body>
    <div class="no-print" style="text-align: center; margin-bottom: 20px;">
        <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print / Save as PDF</button>
    </div>

    <div class="header">
        <h1><span>B.A.T.S.</span> Investigation Report</h1>
        <p>Block Audit Tracing Standard - Case ID: ${investigation.caseId || 'N/A'}</p>
        <p>Generated: ${new Date().toLocaleString()}</p>
    </div>

    <div class="info-grid">
        <div class="info-box">
            <h3>üìä Investigation Summary</h3>
            <p><strong>Case ID:</strong> ${investigation.caseId || 'N/A'}</p>
            <p><strong>Total Victims:</strong> ${investigation.victims?.length || 0}</p>
            <p><strong>Total Hops:</strong> ${investigation.hops?.length || 0}</p>
            <p><strong>Status:</strong> ${investigation.isCompleted ? 'Completed' : 'In Progress'}</p>
        </div>
        <div class="info-box">
            <h3>üí∞ Financial Overview</h3>
            <p><strong>Root Total:</strong> Calculating...</p>
            <p><strong>Currencies Traced:</strong> Multiple</p>
            <p><strong>Export Date:</strong> ${new Date().toLocaleDateString()}</p>
        </div>
    </div>

    <div class="visualization">
        <h2 style="color: #2c3e50; margin-bottom: 15px;">Investigation Flow Visualization</h2>
        <img src="${visualizationImage}" alt="B.A.T.S. Visualization">
    </div>

    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ecf0f1; text-align: center; color: #7f8c8d; font-size: 12px;">
        <p>Generated with B.A.T.S. (Block Audit Tracing Standard)</p>
        <p>ü§ñ Powered by Claude Code</p>
    </div>
</body>
</html>`;

            printWindow.document.write(pdfHTML);
            printWindow.document.close();
        }

        // Wait for data from opener window
        if (window.opener && window.opener.investigation) {
            initializeVisualization(window.opener.investigation);
        } else {
            console.log('Waiting for investigation data from opener window...');
        }
    </script>
</body>
</html>
